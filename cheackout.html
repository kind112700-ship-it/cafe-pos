<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="cheackout.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <title>í‚¤ì˜¤ìŠ¤í¬ ì£¼ë¬¸ ì‹œìŠ¤í…œ - Cart</title>
</head>

<body>

    <div id="checkout-container">

        <div id="order-details-area">
            <div class="checkout-header">
                <h2>ê²°ì œí•  ì£¼ë¬¸ ë‚´ì—­ í™•ì¸</h2>
                <div id="ticket-number-display">ì£¼ë¬¸ ë²ˆí˜¸: <span>A-001</span></div>
            </div>

            <div class="dine-in-takeout-select">
                <p class="selection-display active" data-type="dine-in">ë§¤ì¥ (For Here)</p>
            </div>

            <ul id="final-order-list">
                <li class="final-order-item">
                    <span class="item-title">ì•„ë©”ë¦¬ì¹´ë…¸ (ICE / Size Up)</span>
                    <span class="item-qty">x 2</span>
                    <span class="item-subtotal">5,000 ì›</span>
                    <div class="item-memo">ìš”ì²­: ìƒ· í•˜ë‚˜ ë” ì¶”ê°€</div>
                </li>
                <li class="final-order-item">
                    <span class="item-title">ì¹´í˜ ë¼ë–¼ (HOT)</span>
                    <span class="item-qty">x 1</span>
                    <span class="item-subtotal">4,500 ì›</span>
                    <div class="item-memo hidden"></div>
                </li>
            </ul>

            <div class="summary-breakdown">
                <div><span>ìƒí’ˆ í•©ê³„</span> <span id="summary-subtotal">9,500 ì›</span></div>
                <div><span>í• ì¸ ê¸ˆì•¡</span> <span id="summary-discount">- 0 ì›</span></div>
                <div class="summary-total-row">
                    <span>ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
                    <span id="final-grand-total">9,500 ì›</span>
                </div>
            </div>
        </div>

        <div id="payment-actions-area">

            <div class="payment-section member-section">
                <h3>ë©¤ë²„ì‹­ / í¬ì¸íŠ¸ ì‚¬ìš©</h3>
                <div class="member-input-row">
                    <input type="tel" placeholder="íœ´ëŒ€í° ë²ˆí˜¸ ì…ë ¥" id="member-phone">
                    <button class="func-btn blue-btn" id="member-search-btn">ì¡°íšŒ</button>
                </div>
                <div id="member-info" class="hidden">
                    <p>ì”ì—¬ í¬ì¸íŠ¸: <span id="current-point">1,500 P</span></p>
                    <div class="point-use-row">
                        <input type="number" placeholder="ì‚¬ìš©í•  í¬ì¸íŠ¸" id="point-to-use" value="0">
                        <button class="func-btn small-btn" id="use-all-point-btn">ì „ì•¡ ì‚¬ìš©</button>
                    </div>
                </div>
            </div>

            <div class="payment-section method-section">
                <h3>ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ</h3>
                <div class="payment-method-grid">
                    <button class="func-btn pay-method" data-method="card">ì¹´ë“œ ê²°ì œ</button>
                    <button class="func-btn pay-method" data-method="cash">í˜„ê¸ˆ ê²°ì œ</button>
                    <button class="func-btn pay-method" data-method="mobile">ê°„í¸ ê²°ì œ</button>
                    <button class="func-btn pay-method" data-method="split">ë¶€ë¶„ ê²°ì œ</button>
                </div>

                <div id="cash-module" class="cash-module hidden">
                    <label>ë°›ì€ ê¸ˆì•¡</label>
                    <input type="number" id="cash-received" placeholder="ë°›ì€ ê¸ˆì•¡ ì…ë ¥">
                    <div class="change-display">
                        ê±°ìŠ¤ë¦„ëˆ: <span id="cash-change">0 ì›</span>
                    </div>
                </div>
            </div>

            <div class="payment-section final-action-section">
                <div class="receipt-select-row">
                    <span>ì˜ìˆ˜ì¦ ë°œê¸‰:</span>
                    <button class="func-btn small-btn active" data-receipt="paper">ì¢…ì´</button>
                    <button class="func-btn small-btn" data-receipt="none">ë¯¸ë°œê¸‰</button>
                </div>               

                <button id="final-checkout-btn">ê²°ì œ ì™„ë£Œ ë° ì£¼ë¬¸ í™•ì •</button>
                <button id="cancel-checkout-btn">ê²°ì œ ì·¨ì†Œ / ëŒì•„ê°€ê¸°</button>
            </div>

        </div>

    </div>

    <div id="confirm-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3>ê²°ì œ í™•ì¸</h3>
            <p>ì´ <span id="modal-confirm-amount" style="color:#cc0000; font-weight:bold;">0 ì›</span>ì„ ê²°ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="modal-footer">
                <button id="modal-cancel-confirm">ì·¨ì†Œ</button>
                <button id="modal-proceed-payment">ê²°ì œ ì§„í–‰</button>
            </div>
        </div>
    </div>

    <script>
        // ... ì´ì „ jQuery ì½”ë“œ ì „ì²´ë¥¼ ì—¬ê¸°ì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸° ...
        $(document).ready(function () {
            // ----------------------------------------------------
            // 1. ì´ˆê¸° ê¸ˆì•¡ ê³„ì‚° (ì‹¤ì œ ë°ì´í„° ì—°ë™ ì „, ê°€ìƒìœ¼ë¡œ ì„¤ì •)
            // ----------------------------------------------------
            let finalTotalAmount = 9500; // ì´ˆê¸° ìµœì¢… ê²°ì œ ê¸ˆì•¡ (ìƒí’ˆ í•©ê³„)
            let currentDiscount = 0;

            // ê¸ˆì•¡ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (í¬ì¸íŠ¸/í• ì¸ ì ìš© ì‹œ í˜¸ì¶œ)
            function updateFinalTotal() {
                const subtotal = finalTotalAmount + currentDiscount; // í• ì¸ ì ìš© ì „ ê¸ˆì•¡ìœ¼ë¡œ ê°€ì •
                let newTotal = subtotal - currentDiscount;

                // ìµœì¢… ê¸ˆì•¡ì€ 0 ë¯¸ë§Œì´ ë  ìˆ˜ ì—†ìŒ
                if (newTotal < 0) {
                    newTotal = 0;
                    currentDiscount = subtotal; // í• ì¸ ê¸ˆì•¡ì„ ìƒí’ˆ í•©ê³„ê¹Œì§€ë§Œ ì ìš©
                }

                $('#summary-discount').text(`- ${currentDiscount.toLocaleString()} ì›`);
                $('#final-grand-total').text(`${newTotal.toLocaleString()} ì›`);

                // ëª¨ë‹¬ íŒì—… ê¸ˆì•¡ë„ ì—…ë°ì´íŠ¸
                $('#modal-confirm-amount').text(`${newTotal.toLocaleString()} ì›`);
            }

            // ì´ˆê¸° ê¸ˆì•¡ ì„¤ì •
            updateFinalTotal();

            // ----------------------------------------------------
            // 3. ë©¤ë²„ì‹­ í¬ì¸íŠ¸ ì‚¬ìš© ë¡œì§
            // ----------------------------------------------------

            // ê°€ìƒ í¬ì¸íŠ¸ ì”ì•¡ (ì‹¤ì œë¡œëŠ” DB ì¡°íšŒ í•„ìš”)
            const MAX_POINT = 5000;
            $('#current-point').text(`${MAX_POINT.toLocaleString()} P`);
            $('#member-info').removeClass('hidden'); // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë°”ë¡œ í‘œì‹œ

            // 'ì „ì•¡ ì‚¬ìš©' ë²„íŠ¼
            $('#use-all-point-btn').on('click', function () {
                const total = parseInt($('#summary-subtotal').text().replace(/[^0-9]/g, ''));

                // ìƒí’ˆ í•©ê³„ ë˜ëŠ” ìµœëŒ€ ì”ì—¬ í¬ì¸íŠ¸ ì¤‘ ë” ì‘ì€ ê°’ì„ ì ìš©
                let usablePoint = Math.min(MAX_POINT, total);
                $('#point-to-use').val(usablePoint);
                $('#point-to-use').trigger('input'); // input ì´ë²¤íŠ¸ ê°•ì œ ì‹¤í–‰
            });

            // ì‚¬ìš©í•  í¬ì¸íŠ¸ ì…ë ¥ ì‹œ ë¡œì§
            $('#point-to-use').on('input', function () {
                let usePoint = parseInt($(this).val()) || 0;
                const total = parseInt($('#summary-subtotal').text().replace(/[^0-9]/g, ''));

                // ìµœëŒ€ ì‚¬ìš© ê¸ˆì•¡ ì œí•œ (ì”ì•¡ ë˜ëŠ” ìƒí’ˆ í•©ê³„ ì¤‘ ë” ì‘ì€ ê°’)
                const maxUse = Math.min(MAX_POINT, total);

                if (usePoint > maxUse) {
                    usePoint = maxUse;
                    $(this).val(maxUse);
                } else if (usePoint < 0) {
                    usePoint = 0;
                    $(this).val(0);
                }

                currentDiscount = usePoint;
                updateFinalTotal(); // ìµœì¢… ê¸ˆì•¡ ì—…ë°ì´íŠ¸
            });


            // ----------------------------------------------------
            // 4. ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ ë° í˜„ê¸ˆ ëª¨ë“ˆ ì²˜ë¦¬
            // ----------------------------------------------------
            let selectedPaymentMethod = '';

            $('.pay-method').on('click', function () {
                $('.pay-method').removeClass('active');
                $(this).addClass('active');
                selectedPaymentMethod = $(this).data('method');

                // í˜„ê¸ˆ ëª¨ë“ˆ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
                if (selectedPaymentMethod === 'cash') {
                    $('#cash-module').slideDown(200);
                    $('#cash-received').focus();
                } else {
                    $('#cash-module').slideUp(200);
                    // í˜„ê¸ˆ ì™¸ ê²°ì œ ì‹œ ê±°ìŠ¤ë¦„ëˆ ì´ˆê¸°í™”
                    $('#cash-received').val('');
                    $('#cash-change').text('0 ì›');
                }

                console.log("ì„ íƒëœ ê²°ì œ ìˆ˜ë‹¨:", selectedPaymentMethod);
            });

            // í˜„ê¸ˆ ëª¨ë“ˆ - ê±°ìŠ¤ë¦„ëˆ ê³„ì‚°
            $('#cash-received').on('input', function () {
                const received = parseInt($(this).val()) || 0;
                const total = parseInt($('#final-grand-total').text().replace(/[^0-9]/g, ''));
                const change = received - total;

                if (received >= total) {
                    $('#cash-change').text(`${change.toLocaleString()} ì›`);
                    $('#cash-change').css('color', '#0077cc');
                } else {
                    $('#cash-change').text(`${(change).toLocaleString()} ì› (ë¶€ì¡±)`);
                    $('#cash-change').css('color', '#f44336'); // ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë¶€ì¡± ê°•ì¡°
                }
            });


            // ----------------------------------------------------
            // 5. ê²°ì œ ì™„ë£Œ ë° ëª¨ë‹¬ íŒì—… ì²˜ë¦¬
            // ----------------------------------------------------

            // 'ê²°ì œ ì™„ë£Œ' ë²„íŠ¼ í´ë¦­ ì‹œ
            $('#final-checkout-btn').on('click', function () {
                if (!selectedPaymentMethod) {
                    alert('ê²°ì œ ìˆ˜ë‹¨ì„ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.');
                    return;
                }

                const currentTotal = parseInt($('#final-grand-total').text().replace(/[^0-9]/g, ''));

                // í˜„ê¸ˆ ê²°ì œ ì„ íƒ ì‹œ ë°›ì€ ê¸ˆì•¡ ê²€ì¦
                if (selectedPaymentMethod === 'cash') {
                    const receivedCash = parseInt($('#cash-received').val()) || 0;
                    if (receivedCash < currentTotal) {
                        alert('ë°›ì€ ê¸ˆì•¡ì´ ìµœì¢… ê²°ì œ ê¸ˆì•¡ë³´ë‹¤ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                        return;
                    }
                }

                // ê¸ˆì•¡ í™•ì¸ ëª¨ë‹¬ íŒì—… ë„ìš°ê¸°
                $('#modal-confirm-amount').text($('#final-grand-total').text());
                $('#confirm-modal').fadeIn(300);
            });

            // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
            $('#modal-cancel-confirm').on('click', function () {
                $('#confirm-modal').fadeOut(300);
            });

            // ëª¨ë‹¬ ë‚´ 'ê²°ì œ ì§„í–‰' ë²„íŠ¼
            $('#modal-proceed-payment').on('click', function () {
                // â­ï¸ ì‹¤ì œ ì„œë²„ë¡œ ì£¼ë¬¸ ë°ì´í„° ì „ì†¡ ë¡œì§ì´ ë“¤ì–´ê°ˆ ê³³ â­ï¸

                alert(`ğŸ‰ ${$('#final-grand-total').text()} ê²°ì œ ì™„ë£Œ! ì£¼ë¬¸ì„ í™•ì •í•©ë‹ˆë‹¤.`);
                $('#confirm-modal').fadeOut(300);

                // TODO: ì£¼ë¬¸ ë²ˆí˜¸ ë°œí–‰, DB ì €ì¥, KDS í™”ë©´ ì—…ë°ì´íŠ¸ ë“±ì˜ ì„œë²„ í†µì‹  ë¡œì§ ì¶”ê°€ í•„ìš”
            });

        });
    </script>

</body>

</html>